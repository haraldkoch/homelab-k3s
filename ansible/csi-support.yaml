---
- name: Cluster host mods for using storage on k3s
  hosts: all
  become: true
  tasks:

  - name: install CSI support packages
    package:
      name: gptfdisk,lvm2,nfs-utils,open-iscsi,parted,thin-provisioning-tools
      state: present

  - name: load required modules at boot time
    copy:
      content: |
        ceph
        nbd
        rbd
      dest: /etc/modules-load.d/ceph.conf
      owner: root
      group: root
      mode: 0644

  - name: also load the modules now
    community.general.modprobe:
      name: "{{ item }}"
      state: present
    loop:
    - ceph
    - nbd
    - rbd
