---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: home-dns
  namespace: home-dns
spec:
  interval: 15m
  chart:
    spec:
      chart: coredns
      version: 1.16.5
      sourceRef:
        kind: HelmRepository
        name: coredns-charts
        namespace: flux-system

  values:
    image:
      #repository: coredns/coredns
      #tag: 1.8.7
      repository: quay.io/oriedge/k8s_gateway
      tag: v0.2.1

    fullnameOverride: home-dns

    replicaCount: 2
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/instance
                  operator: In
                  values:
                    - home-dns
            topologyKey: "kubernetes.io/hostname"

    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
      # Still need this for compatability
      - key: "node-role.kubernetes.io/master"
        operator: "Exists"

    podAnnotations:
      configmap.reloader.stakater.com/reload: "config,zones,home-dns"

    serviceType: LoadBalancer
    service:
      loadBalancerIP: ${LB_HOME_DNS}
      annotations:
        external-dns.alpha.kubernetes.io/hostname: dns.${SECRET_DOMAIN}
        metallb.universe.tf/allow-shared-ip: dns

    # we have our own rbac config to include ingresses
    rbac:
      create: false
    prometheus:
      service:
        enabled: true

    servers:
      - zones:
          - zone: .
            scheme: dns://
            use_tcp: false
        port: 53
        plugins:
          - name: log
          - name: errors
          - name: health
            configBlock: |-
              lameduck 5s
          - name: ready
          - name: prometheus
            parameters: :9153
          # FIXME use router address
          - name: k8s_gateway
            parameters: ${SECRET_DOMAIN}
            configBlock: |-
              apex home-dns-k8s-gateway.home-dns
              ttl 300
              fallthrough
          - name: forward
            parameters: . ${PRIVATE_GATEWAY}
          - name: loop
          - name: reload
          - name: loadbalance

    extraVolumeMounts:
      - name: zones
        mountPath: /etc/zones
      - name: config
        mountPath: /etc/config

    extraVolumes:
      - name: zones
        configMap:
          defaultMode: 420
          name: zones
      - name: config
        configMap:
          defaultMode: 420
          name: config

    extraConfig:
      import:
        parameters: /etc/config/*.conf
