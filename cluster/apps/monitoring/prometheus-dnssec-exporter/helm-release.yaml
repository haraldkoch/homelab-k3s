---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prometheus-dnssec-exporter
  namespace: monitoring
spec:
  interval: 15m
  chart:
    spec:
      chart: kah-common-chart
      version: 1.1.1
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home-charts
        namespace: flux-system

  values:
    nameOverride: prometheus-dnssec-exporter

    image:
      repository: ghcr.io/haraldkoch/prometheus-dnssec-exporter
      tag: 0.3.1
      pullPolicy: IfNotPresent

    env:
      TZ: America/Toronto

    resolvers:
      - 8.8.8.8:53
      - 1.1.1.1:53
      #- ${LB_BLOCKY}:53
      #- ${LB_HOME_DNS}:53

    service:
      main:
        ports:
          http:
            enabled: false
          metrics:
            enabled: true
            protocol: TCP
            port: 9204
        type: LoadBalancer
        ipFamilyPolicy: PreferDualStack
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "exporters.${SECRET_INTERNAL_DOMAIN}"
          metallb.universe.tf/allow-shared-ip: exporters

    configmap:
      config:
        enabled: false

    persistence:
      config:
        enabled: true
        type: secret
        name: prometheus-dnssec-secret
        mountPath: /config/dnssec-checks
        subPath: dnssec-checks

    ingress:
      main:
        enabled: false

    podAnnotations:
      secret.reloader.stakater.com/reload: prometheus-dnssec-secret

    metrics:
      enabled: true
      serviceMonitor:
        interval: 1m
        scrapeTimeout: 30s
        labels: {}

      prometheusRule:
        enabled: true
        labels: {}
        rules:
          - alert: DNSSECSignatureExpiration
            expr: dnssec_zone_record_days_left{service="{{ template "prometheus-dnssec-exporter.fullname" . }}"} < 10
            for: 1m
            labels:
              severity: warning
            annotations:
              description: |
                 The DNSSEC signature for the {{ "{{ $labels.record }}" }} in {{ "{{ $labels.zone }}" }}
                 type {{ "{{ $labels.type }}" }} expires in {{ "{{ $value }}" }} day(s)
              summary: |
                The DNSSEC signature for the {{ "{{ $labels.record }}" }} in {{ "{{ $labels.zone }}" }} is expiring
          - alert: DNSSECSignatureInvalid
            expr: dnssec_zone_record_resolves{service="{{ template "prometheus-dnssec-exporter.fullname" . }}"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              description: |
                The DNSSEC signature for the {{ "{{ $labels.record }}" }} in {{ "{{ $labels.zone }}" }}
                type {{ "{{ $labels.type }}" }} on resolver {{ "{{ $labels.resolver }}" }} is invalid
              sumary: |
                The DNSSEC signature for the {{ "{{ $labels.record }}" }} in {{ "{{ $labels.zone }}" }}
                on resolver {{ "{{ $labels.resolver }}" }} is invalid
