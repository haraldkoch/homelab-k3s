mage:
  repository: ghcr.io/k8s-at-home/pod-gateway
  tag: v1.4.0

routed_namespaces:
  - downloads

#publicPorts:
#  - hostname: qbittorrent # hostname assigned to the pod
#    IP: 10 # must be an integer between 2 and VXLAN_GATEWAY_FIRST_DYNAMIC_IP (20 by default)
#    ports:
#      - type: udp
#        port: ${VPN_FORWARDED_PORT_1}
#      - type: tcp
#        port: ${VPN_FORWARDED_PORT_1}

settings:
  VPN_INTERFACE: tun0
  VPN_BLOCK_OTHER_TRAFFIC: true
  VPN_TRAFFIC_PORT: "${DOWNLOADS_VPN_PORT}"
  NOT_ROUTED_TO_GATEWAY_CIDRS: "${NETWORK_K8S_POD_CIDR} ${NETWORK_K8S_SERVICE_CIDR} ${NETWORK_K8S_POD_CIDR_V6} ${NETWORK_K8S_SERVICE_CIDR_V6}"
  VPN_LOCAL_CIDRS: "${NETWORK_K8S_POD_CIDR} ${NETWORK_K8S_SERVICE_CIDR} ${NETWORK_K8S_POD_CIDR_V6} ${NETWORK_K8S_SERVICE_CIDR_V6}"

webhook:
  image:
    repository: ghcr.io/k8s-at-home/gateway-admision-controller
    tag: v3.4.0

  gatewayDefault: true
  gatewayLabel: setGateway
  gatewayAnnotation: setGateway

addons:
  netshoot:
    enabled: true

  vpn:
    enabled: true
    type: openvpn

    env:
      TZ: "America/Toronto"
      # I think these two are only used by wireguard
      IPTABLES_BACKEND: legacy
      KILLSWITCH: "false"

    openvpn:
      authSecret: downloads-gateway-vpnconfig
    configFileSecret: downloads-gateway-vpnconfig

    resources:
      requests:
        cpu: "0.001"
        memory: 64Mi
      limits:
        memory: 128Mi

    # livenessProbe:
    #   exec:
    #     command:
    #       - sh
    #       - -c
    #       - if [ $(curl -s https://am.i.mullvad.net/country) = '${VPN_COUNTRY}' ]; then exit 0; else exit $?; fi
    #   initialDelaySeconds: 30
    #   periodSeconds: 60
    #   failureThreshold: 1

    networkPolicy:
      enabled: true

      egress:
        - to:
            - ipBlock:
                cidr: 0.0.0.0/0
          ports:
            - port: ${DOWNLOADS_VPN_PORT}
              protocol: UDP
        - to:
            - namespaceSelector: {}
